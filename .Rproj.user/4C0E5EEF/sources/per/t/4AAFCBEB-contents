#Purpose: Analyze Burbio data on ESSER spending to see how poor school districts compare to richer ones
#Run esser_cleaning_updated_dec_22.R first

library(tidyverse)
library(stringr)

### Questions based on whether there's ANY spending in a category ####

#How many districts are in each poverty quintile?

df %>% group_by(state_poverty_quintile) %>% summarize(district_count = n())
#Around 1,095 schools in each poverty quintile, 533 are NA.
total_districts = df %>% drop_na(state_poverty_quintile) %>% nrow()

#Previous analysis looked at poverty quartile instead of in-state quintile.
#What percent of schools in each poverty tile spend any money in each subcategory?
#poverty_comparison = df_tidy %>% drop_na(poverty_quartile) %>% group_by(subcategory, #poverty_quartile) %>%
#  summarize(pct_of_districts = sum(spending_planned)/1247*100) %>%
#  spread(key=poverty_quartile, value=pct_of_districts)
#Which spending categories demonstrate the largest differences between poorer and richer districts?
#colnames(poverty_comparison) = c('subcategory', 'q1_richest', 'q2', 'q3', 'q4_poorest')
#poverty_comparison = poverty_comparison %>%
#  mutate(poor_rich_diff = q4_poorest - q1_richest) %>%
#  arrange(-poor_rich_diff)

poverty_comparison = df_tidy %>% drop_na(state_poverty_quintile) %>% group_by(subcategory, state_poverty_quintile) %>%
  summarize(pct_of_districts = sum(spending_planned)/total_districts*100) %>%
  spread(key=state_poverty_quintile, value=pct_of_districts)

#Note: Originally for some reason I had sum(spending_planned) divided by 1247. Why did I do that? Make sure the denominator is correct.

#Which spending categories demonstrate the largest differences between poorer and richer districts?

colnames(poverty_comparison) = c('subcategory', 'q1_richest', 'q2', 'q3', 'q4', 'q5_poorest')
poverty_comparison = poverty_comparison %>%
  mutate(poor_rich_diff = q5_poorest - q1_richest,
         poor_rich_ratio = q5_poorest/q1_richest) %>%
  arrange(-poor_rich_diff)

View(poverty_comparison)
#Poorer districts are 2.6 times as likely to spend ESSER money on repairs, 1.5 times as likely to spend ESSER money on HVAC, 1.7 times more likely to spend it on transportation, 3.1 times more likely to spend it on construction and 2.5 times more likely to spend it on outdoor spaces
#write_csv(poverty_comparison, "./analysis/rich_poor_districts_comparison.csv")

#Categories where poorer schools are more likely to spend money, with-in state quintiles: repairs, HVAC, transportation, construction, outdoor equipment

### Questions based on the SHARE of spending in each category ####

#I decided to not look at how richer and poorer districts compare in percent of total spending in each subcategory, because there are so many subcategories that most schools spend 0 in most of them, and this makes it very difficult to get any useful information out of the analysis.
#Instead, I looked at percent spending in the larger categories

df_complete %>% drop_na(state_poverty_quintile)
#2,353 districts in our "complete" list also have poverty data.

#Filter OUT if subcategory includes phrase "Total Category" AND has a "don't include total" flag

spending_comparison = df_complete_tidy %>% drop_na(state_poverty_quintile) %>%
  filter(spending_planned == 1) %>%
#  filter(!(grepl('Total Category', subcategory) & flag == "Don't include total")) %>%
  group_by(state_poverty_quintile, category) %>%
  summarize(spending = sum(spending_amount)) %>%
  spread(key=state_poverty_quintile, value=spending) %>%
  ungroup()

spending_comparison[, -1] = lapply(spending_comparison[,-1], function(x) x/sum(x)*100)
spending_comparison

#Richest districts spent 39% on academics, while poorest districts spend 26%.
#Richest districts spend 18% on facilities/operations, while poorest districts spend 34%.
#Problem: this analysis is not nationally representative. However, it does make me more confident in my overall takeaway from the poverty_comparison analysis that low-income schools were spending more on facilities.

#What if we looked just at California, which has more districts with complete data?

df %>% filter(State=="CA") %>% nrow() #663 districts in CA
df_complete %>% filter(State=="CA") %>% nrow() #551 are complete, or 83%

spending_comparison_ca = df_complete_tidy %>% filter(State == "CA") %>%
  drop_na(state_poverty_quintile) %>%
  filter(spending_planned == 1) %>%
#  filter(!(grepl('Total Category', subcategory) & flag == "Don't include total")) %>%
  group_by(state_poverty_quintile, category) %>%
  summarize(spending = sum(spending_amount)) %>%
  spread(key=state_poverty_quintile, value=spending) %>%
  ungroup()

spending_comparison_ca[, -1] = lapply(spending_comparison_ca[,-1], function(x) x/sum(x)*100)
spending_comparison_ca
#In California, richest schools spend 36% of their ESSER funds on academics, compared to 24% for the poorest schools. Meanwhile, the poorest schools spent 44% on facilities, compared to just 13% for the richest schools. The richest schools also spent 16% on mental/physical health, while poorest schools only spent 9%.

#Find percent of funds spent in each category for each district

district_spending = df_complete_tidy %>% drop_na(state_poverty_quintile) %>%
  filter(spending_planned == 1) %>%
#  filter(!(grepl('Total Category', subcategory) & flag == "Don't include total")) %>%
  group_by(NCES_code, name, State, Locale, pct_children_in_poverty, category) %>%
  summarize(spending=sum(spending_amount)) %>%
  spread(key=category, value=spending) %>%
  ungroup()

district_spending[is.na(district_spending)] = 0

#Convert to percents
district_spending$total = rowSums(district_spending[,c(6:14)])

district_spending[,c(6:15)] = district_spending[,c(6:15)] / district_spending$total * 100
#All rows should add up to 100

district_spending = district_spending %>% mutate(NCES_code=as.character(NCES_code))

#How to calculate percent by row: https://stackoverflow.com/questions/16032826/calculate-row-wise-proportions


#### Find some interesting districts to look at ####

#district_spending %>% filter(pct_children_in_poverty > 21.6) %>%
#  filter(`Academic Interventions and Learning Loss` > 20 & `Facilities and Operations`>40) %>%
#  arrange(-`Facilities and Operations`)
# %>% write_csv(districts_to_reach_out_to.csv)

#top_categories = c("Repairing / improving School Facilities to Reduce Risk of Illness", "Air filtration, HVAC, Heating, Cooling")

#interesting_districts = df_tidy %>% filter(poverty_quartile == 4 & spending_planned == 1) %>%
#  filter(subcategory %in% top_categories) %>%
#  filter(!spending_amount %in% c("x","X")) %>%
#  mutate(spending_amount = as.numeric(spending_amount)) %>%
#  arrange(-spending_amount)

#left_join(interesting_districts, district_spending, by="NCES_code") %>% View()

#interesting_districts %>% slice(1:20) #%>% write_csv("districts_to_reach_out_to2.csv")

#Reached out to: New Britain, Petersburg City, Ford Heights, Monson-Sultana



#### Linear Regression ####

#Do a linear regression to see: as a district increases the poverty rate by one point, the share of spending on academics changes by _____ points.

attach(district_spending)

model = lm(`Academic Interventions and Learning Loss` ~ pct_children_in_poverty + Locale)
summary(model)

#For every percentage point increase in the poverty rate, there is around half a point decrease (-0.53) in the share of ESSER funds spent on academics.
#This analysis has a very low adjusted R-squared so it's not a great model overall -- it should not be used to predict how a school will spend its ESSER funds. But the finding about poverty is highly statistically significant.

confint(model)
#95% confidence interval for the model says that the coefficient is between -0.69 and -0.44.

model = lm(`Facilities and Operations` ~ pct_children_in_poverty + Locale + State)
summary(model)

#For every one point increase in the poverty rate, there was a 0.9 point increase in share of money spent on facilities.

model = lm(`Mental and Physical Health` ~ pct_children_in_poverty + Locale + State)
summary(model)

#For every one point increase in the poverty rate, there was a 0.14 point decrease in share of money spent on mental health.

confint(model)
#95% confidence interval is between -0.2 and -0.08. (Wanted to check that it didn't go across 0.)

#This model is not nationally representative since certain states like California are over-represented. What if we looked just at California? (Around half the districts in California have complete data.)

ca_spending = district_spending %>% filter(State=="CA")

attach(ca_spending)

model = lm(`Academic Interventions and Learning Loss` ~ pct_children_in_poverty + Locale)
summary(model)

#For every percentage point increase in the poverty rate, there is around half a point decrease in the share of ESSER funds spent on academics. Still not a great R-squared or p-value.

model = lm(`Facilities and Operations` ~ pct_children_in_poverty + Locale)
summary(model)

#For every point increase in the poverty, 1.1 point increase in share of ESSER funds spent on facilities. Pretty good P-value, still not a great adjusted R-squared.
